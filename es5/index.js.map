{"version":3,"sources":["../src/index.js"],"names":["require","isGenerator","toArray","errorToJson","toPromise","call","config","handlers","fn","args","run","input","el","generatorOperation","el1","getExecutionLog","noFunctionMessage","Error","getNextOutput","output","isList","done","fn2","commandsList","processCommands","then","unwrappedResults","unwrapResults","results","step","catch","e","Promise","reject","op","g","apply","value","Array","isArray","commands","pc","c","index","processCommand","promises","map","all","command","start","Date","now","result","type","end","report","success","r","onCommandComplete","latency","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["const { isGenerator, toArray, errorToJson, toPromise } = require('./util')\n\nfunction call(config, handlers, fn, ...args) {\n  return run(config, handlers, fn, args)\n}\n\nfunction run(config, handlers, fn, input, el, generatorOperation = 'next') {\n  try {\n    const el1 = getExecutionLog(el)\n    if (!fn) {\n      const noFunctionMessage =\n        'A function is required. Perhaps your function is undefined?'\n      throw new Error(noFunctionMessage)\n    }\n    const { output, isList, done, fn2 } = getNextOutput(\n      fn,\n      input,\n      generatorOperation\n    )\n    if (done) return toPromise(output)\n    const commandsList = toArray(output)\n    return processCommands(config, handlers, commandsList, el1)\n      .then(results => {\n        const unwrappedResults = unwrapResults(isList, results)\n        el1.step = el1.step + 1 // mutate in place\n        return run(config, handlers, fn2, unwrappedResults, el1)\n      })\n      .catch(e => {\n        //  ok to mutate?\n        el1.step = el1.step + 1 // mutate in place\n        return run(config, handlers, fn2, e, el1, 'throw')\n      })\n  } catch (e) {\n    return Promise.reject(errorToJson(e))\n  }\n}\n\nfunction getExecutionLog(el) {\n  return (\n    el || {\n      step: 0\n    }\n  )\n}\n\nfunction unwrapResults(isList, results) {\n  return isList ? results : results[0]\n}\n\nfunction getNextOutput(fn, input, op = 'next') {\n  const g = isGenerator(fn) ? fn.apply(null, input) : fn\n  const { value: output, done } = g[op](input)\n  return {\n    output,\n    isList: Array.isArray(output),\n    done,\n    fn2: g\n  }\n}\n\nfunction processCommands(config, handlers, commands, el) {\n  try {\n    const pc = (c, index) => processCommand(config, handlers, c, el, index)\n    const promises = commands.map(pc)\n    return Promise.all(promises)\n  } catch (e) {\n    return Promise.reject(e)\n  }\n}\n\nfunction processCommand(config, handlers, command, el, index) {\n  const start = Date.now()\n  let result\n  try {\n    result = handlers[command.type](command, { call, config, handlers })\n  } catch (e) {\n    result = Promise.reject(e)\n  }\n  return toPromise(result)\n    .then(r => {\n      const end = Date.now()\n      report({\n        success: true,\n        config,\n        command,\n        step: el.step,\n        index,\n        result: r,\n        start,\n        end\n      })\n      return r\n    })\n    .catch(e => {\n      const end = Date.now()\n      report({\n        success: false,\n        config,\n        command,\n        step: el.step,\n        index,\n        result: errorToJson(e),\n        start,\n        end\n      })\n      throw e\n    })\n}\n\nfunction report({ success, command, index, step, result, config, start, end }) {\n  if (!config.onCommandComplete) return\n  const r = {\n    success,\n    command,\n    latency: end - start,\n    start,\n    end,\n    index,\n    step,\n    result,\n    config\n  }\n  config.onCommandComplete(r)\n}\n\nmodule.exports = {\n  call\n}\n"]}